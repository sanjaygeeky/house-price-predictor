name: MLOps-CI

on:
  push: 
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  workflow:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: data processing
      run: |
        python src/data/run_processing.py \
        --input data/raw/house_data.csv \
        --output data/processed/cleaned_house_data.csv
    - name: feature engineering
      run: |
        python src/features/engineer.py \
          --input data/processed/cleaned_house_data.csv \
          --output data/processed/featured_house_data.csv \
          --preprocessor models/trained/preprocessor.pkl
    - name: model startup
      run: |
       docker run -idt --name mlflow -p 5000:5000 \
       -v ${{ github.workspace }}/mlruns:/mlflow/mlruns \
       -e MLFLOW_TRACKING_URI=file:///mlflow mlflow/mlflow:latest mlflow server --backend-store-uri file:///mlflow/mlruns --default-artifact-root /mlflow/mlruns --host  
    - name: model training
      run: |
        python src/models/train.py \
          --input data/processed/featured_house_data.csv \
          --model_output models/trained/house_price_model.pkl \
          --preprocessor_output models/trained/preprocessor.pkl \
          --mlflow_tracking_uri http://localhost:5000 \
          --mlflow_experiment_name house_price_prediction
    - name: model evaluation
      run: |
        python src/models/evaluate.py \
          --input data/processed/featured_house_data.csv \
          --model_input models/trained/house_price_model.pkl \
          --preprocessor_input models/trained/preprocessor.pkl \
          --mlflow_tracking_uri http://localhost:5000 \
          --mlflow_experiment_name house_price_prediction
    - name: model deployment
      run: |
        python src/models/deploy.py \
          --model_input models/trained/house_price_model.pkl \
          --preprocessor_input models/trained/preprocessor.pkl \
          --deployment_path models/production/house_price_model.pkl \
          --preprocessor_deployment_path models/production/preprocessor.pkl
    - name: Stop and remove mlflow container
      run: |
        docker stop mlflow
        docker rm mlflow       